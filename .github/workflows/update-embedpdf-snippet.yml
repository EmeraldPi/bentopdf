name: Update EmbedPDF Snippet

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1" # Weekly; adjust as needed

jobs:
  update-snippet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Enable corepack (pnpm)
        run: corepack enable

      - name: Prepare workspace
        run: |
          mkdir -p vendor/embedpdf
          npm config set cache ./\.npm-cache

      - name: Clone upstream embed-pdf-viewer
        run: git clone https://github.com/embedpdf/embed-pdf-viewer ../embed-pdf-viewer

      - name: Install upstream deps
        working-directory: ../embed-pdf-viewer
        run: pnpm install --frozen-lockfile

      - name: Build snippet
        working-directory: ../embed-pdf-viewer
        run: pnpm run build:snippet

      - name: Pack snippet tarball
        working-directory: ../embed-pdf-viewer
        run: |
          npm pack ./packages/build --pack-destination ../bentopdf/vendor/embedpdf
          ls -l ../bentopdf/vendor/embedpdf

      - name: Update package.json dependency path
        run: |
          TARBALL=$(ls vendor/embedpdf/embedpdf-*.tgz | sort | tail -n1)
          node -e "const fs=require('fs');const pkg=require('./package.json');const tar=process.argv[1];pkg.dependencies['embedpdf-snippet-i18n']=`file:${tar}`;fs.writeFileSync('package.json',JSON.stringify(pkg,null,2)+'\\n');" "$TARBALL"

      - name: Refresh lockfile
        run: npm install --package-lock-only

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update embedpdf snippet"
          title: "Update vendored EmbedPDF snippet"
          body: |
            - Build snippet from upstream embed-pdf-viewer via `npm run build:snippet`
            - Pack tarball into `vendor/embedpdf/` and point dependency to it
            - Refresh package-lock.json
          branch: chore/update-embedpdf-snippet
          delete-branch: true
